<!DOCTYPE html>
<html>
<head>
    
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css"/>
    
            <meta name="viewport" content="width=device-width,
                initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
            <style>
                #map_3bfb1e9f4420233d456e6ec5655a8a75 {
                    position: relative;
                    width: 100.0%;
                    height: 100.0%;
                    left: 0.0%;
                    top: 0.0%;
                }
                .leaflet-container { font-size: 1rem; }
            </style>

            <style>html, body {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }
            </style>

            <style>#map {
                position:absolute;
                top:0;
                bottom:0;
                right:0;
                left:0;
                }
            </style>

            <script>
                L_NO_TOUCH = false;
                L_DISABLE_3D = false;
            </script>

        
</head>
<body>
    
    
    <script>
        (function() {
            var checkMapInterval = setInterval(function() {
                var map_id = Object.keys(window).find(key => key.startsWith('map_'));
                if (window[map_id]) {
                    clearInterval(checkMapInterval);
                    var map = window[map_id];
                    var layer_objects = {"Weekend - Stops": "feature_group_e0f34281265eaa62d03b139ad558749d", "Weekend - Frequent Stop Radius (500m)": "feature_group_0e5ddbe3135f6e7e44f22d746cdf138d", "Workday - Stops": "feature_group_117d97961da0e29ba884b3e1e13a1303", "Workday - Frequent Stop Radius (500m)": "feature_group_47b5dd27eb0738599cb8f31c462dd416", "Saturday - Stops": "feature_group_afc98155233253fd47eacf04e498b11f", "Saturday - Frequent Stop Radius (500m)": "feature_group_1d89c0233dfa85f88f47b5741551d569", "Sunday - Stops": "feature_group_eb82537f75e89c683e84e25b4eeb1801", "Sunday - Frequent Stop Radius (500m)": "feature_group_a32313d3dec618538502c01262d04a5d"};
                    var loadedData = {};
                    var arrivalsData = null;
                    var activeDayType = 'weekend'; // Default

                    fetch('./data/arrivals.json')
                        .then(response => response.json())
                        .then(data => {
                            arrivalsData = data;
                            loadGeoJson('Weekend - Stops', layerConfigs['Weekend - Stops'].url, layerConfigs['Weekend - Stops'].options);
                        })
                        .catch(err => console.error('Failed to load arrivals.json', err));

                    var layerConfigs = {
                        'Weekend - Stops': { url: './data/weekend_stops.geojson', options: { pointToLayer: createStopMarker } },
                        'Weekend - Frequent Stop Radius (500m)': { url: './data/weekend_radius.geojson', options: { style: radiusStyle } },
                        'Workday - Stops': { url: './data/workday_stops.geojson', options: { pointToLayer: createStopMarker } },
                        'Workday - Frequent Stop Radius (500m)': { url: './data/workday_radius.geojson', options: { style: radiusStyle } },
                        'Saturday - Stops': { url: './data/saturday_stops.geojson', options: { pointToLayer: createStopMarker } },
                        'Saturday - Frequent Stop Radius (500m)': { url: './data/saturday_radius.geojson', options: { style: radiusStyle } },
                        'Sunday - Stops': { url: './data/sunday_stops.geojson', options: { pointToLayer: createStopMarker } },
                        'Sunday - Frequent Stop Radius (500m)': { url: './data/sunday_radius.geojson', options: { style: radiusStyle } }
                    };

                    function radiusStyle(feature) { return { fillColor: '#3186cc', color: 'none', weight: 0, fillOpacity: 0.3 }; }

                    function createStopMarker(feature, latlng) {
                        var marker = L.circleMarker(latlng, { radius: 5, color: feature.properties.color, fillColor: feature.properties.color, fillOpacity: 0.7 });
                        marker.feature = feature; // Attach feature data to marker
                        marker.bindTooltip(feature.properties.tooltip);
                        marker.on('click', function(e) {
                            var props = e.target.feature.properties;
                            var popupContent = buildPopupHtml(props, activeDayType);
                            var iframe = document.createElement('iframe');
                            iframe.style.width = '600px'; iframe.style.height = '450px'; iframe.style.border = 'none';
                            iframe.srcdoc = popupContent;
                            marker.bindPopup(L.popup({ maxWidth: 600 }).setContent(iframe)).openPopup();
                        });
                        return marker;
                    }
                    
                    function generateArrivalRowsHtml(arrivals) {
                        if (!arrivals || arrivals.length === 0) return '<tr><td colspan="4" style="text-align: center;">No service in this window.</td></tr>';
                        let extended = [{ arrival_time: '10:00:00', route_short_name: '---', trip_headsign: 'Start of Window' }, ...arrivals, { arrival_time: '20:00:00', route_short_name: '---', trip_headsign: 'End of Window' }];
                        extended.sort((a, b) => a.arrival_time.localeCompare(b.arrival_time));
                        
                        let rowsHtml = '';
                        for (let i = 0; i < extended.length; i++) {
                            let arrival = extended[i];
                            let prevTime = (i > 0) ? new Date('1970-01-01T' + extended[i-1].arrival_time + 'Z') : null;
                            let currTime = new Date('1970-01-01T' + arrival.arrival_time + 'Z');
                            let wait = prevTime ? Math.round((currTime - prevTime) / 60000) : '-';
                            let style = (wait > 30) ? 'background-color: #ffdddd;' : '';
                            if (arrival.trip_headsign.includes('Window')) style += 'color: #888; font-style: italic;';
                            rowsHtml += `<tr style="${style}"><td style="padding:2px;">${arrival.arrival_time.substring(0,5)}</td><td style="padding:2px;">${arrival.route_short_name}</td><td style="padding:2px;">${arrival.trip_headsign}</td><td style="padding:2px;text-align:right;">${wait}</td></tr>`;
                        }
                        return rowsHtml;
                    }

                    function buildPopupHtml(props, dayType) {
                        if (!arrivalsData || !arrivalsData[dayType]) return 'Loading arrival data...';
                        
                        let stopTableHtml = '';
                        let groupTableHtml = '';

                        if (dayType === 'weekend') {
                            // Filter weekend data into Saturday and Sunday
                            const allStopArrivals = arrivalsData[dayType].filter(a => a.stop_id === props.stop_id);
                            const allGroupArrivals = arrivalsData[dayType].filter(a => a.stop_group_id === props.group_id);

                            const stopArrivalsSat = allStopArrivals.filter(a => a.service_day === 'Saturday');
                            const stopArrivalsSun = allStopArrivals.filter(a => a.service_day === 'Sunday');
                            const groupArrivalsSat = allGroupArrivals.filter(a => a.service_day === 'Saturday');
                            const groupArrivalsSun = allGroupArrivals.filter(a => a.service_day === 'Sunday');
                            
                            // Build a single stream of rows for the stop table: Saturday arrivals then Sunday arrivals
                            stopTableHtml = `
                                <tr><td colspan="4" style="text-align:center; font-weight:bold; background-color:#eee;">Saturday</td></tr>
                                ${generateArrivalRowsHtml(stopArrivalsSat)}
                                <tr><td colspan="4" style="text-align:center; font-weight:bold; background-color:#eee;">Sunday</td></tr>
                                ${generateArrivalRowsHtml(stopArrivalsSun)}
                            `;

                            // Build a single stream of rows for the group table: Saturday arrivals then Sunday arrivals
                            groupTableHtml = `
                                <tr><td colspan="4" style="text-align:center; font-weight:bold; background-color:#eee;">Saturday</td></tr>
                                ${generateArrivalRowsHtml(groupArrivalsSat)}
                                <tr><td colspan="4" style="text-align:center; font-weight:bold; background-color:#eee;">Sunday</td></tr>
                                ${generateArrivalRowsHtml(groupArrivalsSun)}
                            `;

                        } else {
                            // Handle single days (workday, saturday, sunday)
                            let stopArrivals = arrivalsData[dayType].filter(a => a.stop_id === props.stop_id);
                            let groupArrivals = arrivalsData[dayType].filter(a => a.stop_group_id === props.group_id);
                            
                            stopTableHtml = generateArrivalRowsHtml(stopArrivals);
                            groupTableHtml = generateArrivalRowsHtml(groupArrivals);
                        }

                        return `<b>Stop:</b> ${props.stop_name} (${props.stop_id})<br><b>Group:</b> ${props.group_name} (${props.group_id})<hr>
                        <table style="width:100%;">
                            <tr style="vertical-align:top;">
                                <td style="width:50%; padding-right:5px;"><b>This Stop's Arrivals</b><div style="max-height:300px; overflow-y:auto;"><table style="width:100%; border-collapse:collapse;"><tr style="text-align:left;"><th>Time</th><th>Line</th><th>Dir</th><th>Wait</th></tr>${stopTableHtml}</table></div></td>
                                <td style="width:50%; padding-left:5px; border-left: 1px solid #ccc;"><b>Entire Group's Arrivals</b><div style="max-height:300px; overflow-y:auto;"><table style="width:100%; border-collapse:collapse;"><tr style="text-align:left;"><th>Time</th><th>Line</th><th>Dir</th><th>Wait</th></tr>${groupTableHtml}</table></div></td>
                            </tr>
                        </table>`;
                    }

                    function loadGeoJson(layerName, url, options) {
                        if (loadedData[layerName]) return;
                        fetch(url)
                            .then(response => response.json())
                            .then(data => {
                                var leaflet_variable_name = layer_objects[layerName];
                                var leaflet_layer_object = window[leaflet_variable_name];
                                if (leaflet_layer_object) {
                                    var geoJsonLayer = L.geoJson(data, options);
                                    geoJsonLayer.addTo(leaflet_layer_object);
                                    loadedData[layerName] = true;
                                }
                            })
                            .catch(err => console.error('Error loading GeoJSON:', err));
                    }

                    map.on('baselayerchange', function(e) {
                        activeDayType = e.name.split(' ')[0].toLowerCase();
                    });

                    map.on('overlayadd', function(e) {
                        if (layerConfigs[e.name]) {
                            loadGeoJson(e.name, layerConfigs[e.name].url, layerConfigs[e.name].options);
                        }
                    });
                }
            }, 100);
        })();
    </script>
    
    
            <div class="folium-map" id="map_3bfb1e9f4420233d456e6ec5655a8a75" ></div>
        
</body>
<script>
    
    
            var map_3bfb1e9f4420233d456e6ec5655a8a75 = L.map(
                "map_3bfb1e9f4420233d456e6ec5655a8a75",
                {
                    center: [53.4285, 14.5528],
                    crs: L.CRS.EPSG3857,
                    ...{
  "zoom": 12,
  "zoomControl": true,
  "preferCanvas": false,
}

                }
            );

            

        
    
            var tile_layer_d087ef7dec28b157c7b3209e4744add3 = L.tileLayer(
                "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
                {
  "minZoom": 0,
  "maxZoom": 19,
  "maxNativeZoom": 19,
  "noWrap": false,
  "attribution": "\u0026copy; \u003ca href=\"https://www.openstreetmap.org/copyright\"\u003eOpenStreetMap\u003c/a\u003e contributors",
  "subdomains": "abc",
  "detectRetina": false,
  "tms": false,
  "opacity": 1,
}

            );
        
    
            tile_layer_d087ef7dec28b157c7b3209e4744add3.addTo(map_3bfb1e9f4420233d456e6ec5655a8a75);
        
    
            var feature_group_e0f34281265eaa62d03b139ad558749d = L.featureGroup(
                {
}
            );
        
    
            feature_group_e0f34281265eaa62d03b139ad558749d.addTo(map_3bfb1e9f4420233d456e6ec5655a8a75);
        
    
            var feature_group_0e5ddbe3135f6e7e44f22d746cdf138d = L.featureGroup(
                {
}
            );
        
    
            var feature_group_117d97961da0e29ba884b3e1e13a1303 = L.featureGroup(
                {
}
            );
        
    
            var feature_group_47b5dd27eb0738599cb8f31c462dd416 = L.featureGroup(
                {
}
            );
        
    
            var feature_group_afc98155233253fd47eacf04e498b11f = L.featureGroup(
                {
}
            );
        
    
            var feature_group_1d89c0233dfa85f88f47b5741551d569 = L.featureGroup(
                {
}
            );
        
    
            var feature_group_eb82537f75e89c683e84e25b4eeb1801 = L.featureGroup(
                {
}
            );
        
    
            var feature_group_a32313d3dec618538502c01262d04a5d = L.featureGroup(
                {
}
            );
        
    
            var layer_control_08d6f8383688145f597c0491dbcd77ca_layers = {
                base_layers : {
                    "openstreetmap" : tile_layer_d087ef7dec28b157c7b3209e4744add3,
                },
                overlays :  {
                    "Weekend - Stops" : feature_group_e0f34281265eaa62d03b139ad558749d,
                    "Weekend - Frequent Stop Radius (500m)" : feature_group_0e5ddbe3135f6e7e44f22d746cdf138d,
                    "Workday - Stops" : feature_group_117d97961da0e29ba884b3e1e13a1303,
                    "Workday - Frequent Stop Radius (500m)" : feature_group_47b5dd27eb0738599cb8f31c462dd416,
                    "Saturday - Stops" : feature_group_afc98155233253fd47eacf04e498b11f,
                    "Saturday - Frequent Stop Radius (500m)" : feature_group_1d89c0233dfa85f88f47b5741551d569,
                    "Sunday - Stops" : feature_group_eb82537f75e89c683e84e25b4eeb1801,
                    "Sunday - Frequent Stop Radius (500m)" : feature_group_a32313d3dec618538502c01262d04a5d,
                },
            };
            let layer_control_08d6f8383688145f597c0491dbcd77ca = L.control.layers(
                layer_control_08d6f8383688145f597c0491dbcd77ca_layers.base_layers,
                layer_control_08d6f8383688145f597c0491dbcd77ca_layers.overlays,
                {
  "position": "topright",
  "collapsed": true,
  "autoZIndex": true,
}
            ).addTo(map_3bfb1e9f4420233d456e6ec5655a8a75);

        
</script>
</html>
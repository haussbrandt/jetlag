<!DOCTYPE html>
<html>
<head>
    
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css"/>
    
            <meta name="viewport" content="width=device-width,
                initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
            <style>
                #map_86334ab4006ad5a8ed79adf60de9289f {
                    position: relative;
                    width: 100.0%;
                    height: 100.0%;
                    left: 0.0%;
                    top: 0.0%;
                }
                .leaflet-container { font-size: 1rem; }
            </style>

            <style>html, body {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }
            </style>

            <style>#map {
                position:absolute;
                top:0;
                bottom:0;
                right:0;
                left:0;
                }
            </style>

            <script>
                L_NO_TOUCH = false;
                L_DISABLE_3D = false;
            </script>

        
</head>
<body>
    
    
    <script>
        (function() {
            var checkMapInterval = setInterval(function() {
                var map_id = Object.keys(window).find(key => key.startsWith('map_'));
                if (window[map_id]) {
                    clearInterval(checkMapInterval);
                    var map = window[map_id];

                    // --- STATE MANAGEMENT ---
                    let activeDayType = 'weekend';
                    let isRadiusVisible = false;
                    let loadedLayers = {}; // Cache for L.geoJson layers
                    let arrivalsData = null;

                    // Create a dedicated pane for the radius layer to control z-index
                    map.createPane('radius_pane');
                    map.getPane('radius_pane').style.zIndex = 450; // Lower than markers (default is 600)
                    map.getPane('radius_pane').style.pointerEvents = 'none'; // *** CRITICAL FIX ***

                    // --- DATA FETCHING ---
                    fetch('./data/arrivals.json')
                        .then(response => response.json())
                        .then(data => {
                            arrivalsData = data;
                            loadAndShowLayer('weekend_stops'); // Initial layer load
                        })
                        .catch(err => console.error('Failed to load arrivals.json', err));

                    // --- UI CONTROL ---
                    const CustomControl = L.Control.extend({
                        onAdd: function(map) {
                            const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                            container.style.backgroundColor = 'white';
                            container.style.padding = '10px';
                            container.style.borderRadius = '5px';
                            container.innerHTML = `
                                <h4 style="margin-top:0; margin-bottom:5px;">Day Type</h4>
                                <input type="radio" id="weekend" name="day_type" value="weekend" checked>
                                <label for="weekend" style="cursor:pointer;">Weekend</label><br>
                                <input type="radio" id="workday" name="day_type" value="workday">
                                <label for="workday" style="cursor:pointer;">Workday</label><br>
                                <input type="radio" id="saturday" name="day_type" value="saturday">
                                <label for="saturday" style="cursor:pointer;">Saturday</label><br>
                                <input type="radio" id="sunday" name="day_type" value="sunday">
                                <label for="sunday" style="cursor:pointer;">Sunday</label><br>
                                <hr style="margin: 10px 0;">
                                <h4 style="margin-top:0; margin-bottom:5px;">Overlays</h4>
                                <input type="checkbox" id="radius_toggle">
                                <label for="radius_toggle" style="cursor:pointer;">Frequent Stop Radius</label>
                            `;
                            L.DomEvent.disableClickPropagation(container);
                            return container;
                        },
                        onRemove: function(map) {}
                    });
                    const control = new CustomControl({ position: 'topright' });
                    map.addControl(control);
                    
                    // --- EVENT LISTENERS for the new control ---
                    document.querySelectorAll('input[name="day_type"]').forEach(radio => {
                        radio.addEventListener('change', (e) => switchDayType(e.target.value));
                    });
                    document.getElementById('radius_toggle').addEventListener('change', (e) => {
                        toggleRadius(e.target.checked);
                    });

                    // --- LAYER LOGIC ---
                    function switchDayType(newDayType) {
                        // Hide old layers
                        if (loadedLayers[activeDayType + '_stops']) map.removeLayer(loadedLayers[activeDayType + '_stops']);
                        if (loadedLayers[activeDayType + '_radius']) map.removeLayer(loadedLayers[activeDayType + '_radius']);
                        
                        activeDayType = newDayType;

                        // Show new layers
                        loadAndShowLayer(activeDayType + '_stops');
                        if (isRadiusVisible) {
                            loadAndShowLayer(activeDayType + '_radius');
                        }
                    }

                    function toggleRadius(isVisible) {
                        isRadiusVisible = isVisible;
                        if (isVisible) {
                            loadAndShowLayer(activeDayType + '_radius');
                        } else {
                            if (loadedLayers[activeDayType + '_radius']) {
                                map.removeLayer(loadedLayers[activeDayType + '_radius']);
                            }
                        }
                    }

                    function loadAndShowLayer(layerKey) {
                        if (loadedLayers[layerKey]) {
                            map.addLayer(loadedLayers[layerKey]);
                            return;
                        }
                        
                        const [day, type] = layerKey.split('_');
                        const url = `./data/${day}_${type}.geojson`;
                        
                        const options = (type === 'stops') 
                            ? { pointToLayer: createStopMarker } 
                            : { style: radiusStyle, pane: 'radius_pane' };

                        fetch(url)
                            .then(response => response.json())
                            .then(data => {
                                const geoJsonLayer = L.geoJson(data, options);
                                loadedLayers[layerKey] = geoJsonLayer;
                                geoJsonLayer.addTo(map);
                            })
                            .catch(err => console.error(`Error loading ${url}:`, err));
                    }

                    // --- MARKER & POPUP LOGIC ---
                    function radiusStyle(feature) { return { fillColor: '#3186cc', color: 'none', weight: 0, fillOpacity: 0.3 }; }

                    function createStopMarker(feature, latlng) {
                        var marker = L.circleMarker(latlng, { radius: 5, color: feature.properties.color, fillColor: feature.properties.color, fillOpacity: 0.7 });
                        marker.feature = feature;
                        marker.bindTooltip(feature.properties.tooltip);
                        marker.on('click', function(e) {
                            var props = e.target.feature.properties;
                            var popupContent = buildPopupHtml(props);
                            var iframe = document.createElement('iframe');
                            iframe.style.width = '600px'; iframe.style.height = '450px'; iframe.style.border = 'none';
                            iframe.srcdoc = popupContent;
                            marker.bindPopup(L.popup({ maxWidth: 600 }).setContent(iframe)).openPopup();
                        });
                        return marker;
                    }
                    
                    function generateArrivalRowsHtml(arrivals) {
                        if (!arrivals || arrivals.length === 0) return '<tr><td colspan="4" style="text-align: center;">No service in this window.</td></tr>';
                        let extended = [{ arrival_time: '10:00:00', route_short_name: '---', trip_headsign: 'Start of Window' }, ...arrivals, { arrival_time: '20:00:00', route_short_name: '---', trip_headsign: 'End of Window' }];
                        extended.sort((a, b) => a.arrival_time.localeCompare(b.arrival_time));
                        
                        let rowsHtml = '';
                        for (let i = 0; i < extended.length; i++) {
                            let arrival = extended[i];
                            let prevTime = (i > 0) ? new Date('1970-01-01T' + extended[i-1].arrival_time + 'Z') : null;
                            let currTime = new Date('1970-01-01T' + arrival.arrival_time + 'Z');
                            let wait = prevTime ? Math.round((currTime - prevTime) / 60000) : '-';
                            let style = (wait > 30) ? 'background-color: #ffdddd;' : '';
                            if (arrival.trip_headsign.includes('Window')) style += 'color: #888; font-style: italic;';
                            rowsHtml += `<tr style="${style}"><td style="padding:2px;">${arrival.arrival_time.substring(0,5)}</td><td style="padding:2px;">${arrival.route_short_name}</td><td style="padding:2px;">${arrival.trip_headsign}</td><td style="padding:2px;text-align:right;">${wait}</td></tr>`;
                        }
                        return rowsHtml;
                    }

                    function buildPopupHtml(props) {
                        if (!arrivalsData || !arrivalsData[activeDayType]) return 'Loading arrival data...';
                        
                        let stopTableHtml = '';
                        let groupTableHtml = '';

                        if (activeDayType === 'weekend') {
                            const allStopArrivals = arrivalsData[activeDayType].filter(a => a.stop_id === props.stop_id);
                            const allGroupArrivals = arrivalsData[activeDayType].filter(a => a.stop_group_id === props.group_id);

                            const stopArrivalsSat = allStopArrivals.filter(a => a.service_day === 'Saturday');
                            const stopArrivalsSun = allStopArrivals.filter(a => a.service_day === 'Sunday');
                            const groupArrivalsSat = allGroupArrivals.filter(a => a.service_day === 'Saturday');
                            const groupArrivalsSun = allGroupArrivals.filter(a => a.service_day === 'Sunday');
                            
                            stopTableHtml = `
                                <tr><td colspan="4" style="text-align:center; font-weight:bold; background-color:#eee;">Saturday</td></tr>
                                ${generateArrivalRowsHtml(stopArrivalsSat)}
                                <tr><td colspan="4" style="text-align:center; font-weight:bold; background-color:#eee;">Sunday</td></tr>
                                ${generateArrivalRowsHtml(stopArrivalsSun)}
                            `;
                            groupTableHtml = `
                                <tr><td colspan="4" style="text-align:center; font-weight:bold; background-color:#eee;">Saturday</td></tr>
                                ${generateArrivalRowsHtml(groupArrivalsSat)}
                                <tr><td colspan="4" style="text-align:center; font-weight:bold; background-color:#eee;">Sunday</td></tr>
                                ${generateArrivalRowsHtml(groupArrivalsSun)}
                            `;
                        } else {
                            let stopArrivals = arrivalsData[activeDayType].filter(a => a.stop_id === props.stop_id);
                            let groupArrivals = arrivalsData[activeDayType].filter(a => a.stop_group_id === props.group_id);
                            stopTableHtml = generateArrivalRowsHtml(stopArrivals);
                            groupTableHtml = generateArrivalRowsHtml(groupArrivals);
                        }

                        return `<b>Stop:</b> ${props.stop_name} (${props.stop_id})<br><b>Group:</b> ${props.group_name} (${props.group_id})<hr>
                        <table style="width:100%;">
                            <tr style="vertical-align:top;">
                                <td style="width:50%; padding-right:5px;"><b>This Stop's Arrivals</b><div style="max-height:300px; overflow-y:auto;"><table style="width:100%; border-collapse:collapse;"><tr style="text-align:left;"><th>Time</th><th>Line</th><th>Dir</th><th>Wait</th></tr>${stopTableHtml}</table></div></td>
                                <td style="width:50%; padding-left:5px; border-left: 1px solid #ccc;"><b>Entire Group's Arrivals</b><div style="max-height:300px; overflow-y:auto;"><table style="width:100%; border-collapse:collapse;"><tr style="text-align:left;"><th>Time</th><th>Line</th><th>Dir</th><th>Wait</th></tr>${groupTableHtml}</table></div></td>
                            </tr>
                        </table>`;
                    }
                }
            }, 100);
        })();
    </script>
    
    
            <div class="folium-map" id="map_86334ab4006ad5a8ed79adf60de9289f" ></div>
        
</body>
<script>
    
    
            var map_86334ab4006ad5a8ed79adf60de9289f = L.map(
                "map_86334ab4006ad5a8ed79adf60de9289f",
                {
                    center: [53.4285, 14.5528],
                    crs: L.CRS.EPSG3857,
                    ...{
  "zoom": 12,
  "zoomControl": true,
  "preferCanvas": false,
}

                }
            );

            

        
    
            var tile_layer_c36665f4a11b3d2de5d963dcc45f5b6f = L.tileLayer(
                "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
                {
  "minZoom": 0,
  "maxZoom": 19,
  "maxNativeZoom": 19,
  "noWrap": false,
  "attribution": "\u0026copy; \u003ca href=\"https://www.openstreetmap.org/copyright\"\u003eOpenStreetMap\u003c/a\u003e contributors",
  "subdomains": "abc",
  "detectRetina": false,
  "tms": false,
  "opacity": 1,
}

            );
        
    
            tile_layer_c36665f4a11b3d2de5d963dcc45f5b6f.addTo(map_86334ab4006ad5a8ed79adf60de9289f);
        
</script>
</html>